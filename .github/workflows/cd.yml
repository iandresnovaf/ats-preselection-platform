```yaml                                                                                                                        
   # CD Workflow - Continuous Deployment                                                                                        
   # Se ejecuta solo en pushes a main despuÃ©s de pasar CI                                                                       
                                                                                                                                
   name: CD - Deploy                                                                                                            
                                                                                                                                
   on:                                                                                                                          
     push:                                                                                                                      
       branches: [ main ]                                                                                                       
       paths-ignore:                                                                                                            
         - '**.md'                                                                                                              
         - 'docs/**'                                                                                                            
     workflow_dispatch:                                                                                                         
       inputs:                                                                                                                  
         environment:                                                                                                           
           description: 'Environment to deploy'                                                                                 
           required: true                                                                                                       
           default: 'staging'                                                                                                   
           type: choice                                                                                                         
           options:                                                                                                             
             - staging                                                                                                          
             - production                                                                                                       
                                                                                                                                
   env:                                                                                                                         
     REGISTRY: ghcr.io                                                                                                          
     IMAGE_PREFIX: ${{ github.repository }}                                                                                     
                                                                                                                                
   concurrency:                                                                                                                 
     group: ${{ github.workflow }}-${{ github.ref }}                                                                            
     cancel-in-progress: false                                                                                                  
                                                                                                                                
   jobs:                                                                                                                        
     verify:                                                                                                                    
       name: âœ… Verify CI Status                                                                                                
       runs-on: ubuntu-latest                                                                                                   
       steps:                                                                                                                   
         - name: Check CI status                                                                                                
           uses: actions/github-script@v7                                                                                       
           with:                                                                                                                
             script: |                                                                                                          
               const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({                                       
                 owner: context.repo.owner,                                                                                     
                 repo: context.repo.repo,                                                                                       
                 workflow_id: 'ci.yml',                                                                                         
                 branch: context.ref.replace('refs/heads/', ''),                                                                
                 per_page: 1                                                                                                    
               });                                                                                                              
                                                                                                                                
               if (runs.workflow_runs.length === 0) {                                                                           
                 core.setFailed('No CI runs found');                                                                            
                 return;                                                                                                        
               }                                                                                                                
                                                                                                                                
               const latestRun = runs.workflow_runs[0];                                                                         
               if (latestRun.conclusion !== 'success') {                                                                        
                 core.setFailed(`Latest CI run did not succeed: ${latestRun.conclusion}`);                                      
               }                                                                                                                
                                                                                                                                
     build-and-push:                                                                                                            
       name: ðŸ³ Build & Push Images                                                                                             
       runs-on: ubuntu-latest                                                                                                   
       needs: [verify]                                                                                                          
       permissions:                                                                                                             
         contents: read                                                                                                         
         packages: write                                                                                                        
       steps:                                                                                                                   
         - uses: actions/checkout@v4                                                                                            
         - uses: docker/setup-buildx-action@v3                                                                                  
         - uses: docker/login-action@v3                                                                                         
           with:                                                                                                                
             registry: ${{ env.REGISTRY }}                                                                                      
             username: ${{ github.actor }}                                                                                      
             password: ${{ secrets.GITHUB_TOKEN }}                                                                              
                                                                                                                                
         - name: Extract metadata (Backend)                                                                                     
           id: meta-backend                                                                                                     
           uses: docker/metadata-action@v5                                                                                      
           with:                                                                                                                
             images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/backend                                                        
             tags: |                                                                                                            
               type=ref,event=branch                                                                                            
               type=sha,prefix={{branch}}-,suffix=,format=short                                                                 
               type=raw,value=latest,enable={{is_default_branch}}                                                               
                                                                                                                                
         - name: Extract metadata (Frontend)                                                                                    
           id: meta-frontend                                                                                                    
           uses: docker/metadata-action@v5                                                                                      
           with:                                                                                                                
             images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/frontend                                                       
             tags: |                                                                                                            
               type=ref,event=branch                                                                                            
               type=sha,prefix={{branch}}-,suffix=,format=short                                                                 
               type=raw,value=latest,enable={{is_default_branch}}                                                               
                                                                                                                                
         - name: Build and push backend                                                                                         
           uses: docker/build-push-action@v5                                                                                    
           with:                                                                                                                
             context: ./backend                                                                                                 
             push: true                                                                                                         
             tags: ${{ steps.meta-backend.outputs.tags }}                                                                       
             labels: ${{ steps.meta-backend.outputs.labels }}                                                                   
             platforms: linux/amd64,linux/arm64                                                                                 
                                                                                                                                
         - name: Build and push frontend                                                                                        
           uses: docker/build-push-action@v5                                                                                    
           with:                                                                                                                
             context: ./frontend                                                                                                
             push: true                                                                                                         
             tags: ${{ steps.meta-frontend.outputs.tags }}                                                                      
             labels: ${{ steps.meta-frontend.outputs.labels }}                                                                  
             platforms: linux/amd64,linux/arm64                                                                                 
                                                                                                                                
     deploy-staging:                                                                                                            
       name: ðŸš€ Deploy to Staging                                                                                               
       runs-on: ubuntu-latest                                                                                                   
       needs: [build-and-push]                                                                                                  
       environment:                                                                                                             
         name: staging                                                                                                          
         url: https://staging.ats-platform.com                                                                                  
       if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'staging'                                      
       steps:                                                                                                                   
         - uses: actions/checkout@v4                                                                                            
                                                                                                                                
         - name: Deploy to Staging                                                                                              
           env:                                                                                                                 
             SSH_PRIVATE_KEY: ${{ secrets.STAGING_SSH_KEY }}                                                                    
             SSH_HOST: ${{ secrets.STAGING_HOST }}                                                                              
             SSH_USER: ${{ secrets.STAGING_USER }}                                                                              
           run: |                                                                                                               
             mkdir -p ~/.ssh                                                                                                    
             echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa                                                                            
             chmod 600 ~/.ssh/id_rsa                                                                                            
             ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts                                                                     
                                                                                                                                
             ssh $SSH_USER@$SSH_HOST << 'EOF'                                                                                   
               cd /opt/ats-platform                                                                                             
               docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/backend:main                                             
               docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/frontend:main                                            
               docker-compose -f docker-compose.prod.yml up -d --no-deps backend frontend                                       
               docker-compose -f docker-compose.prod.yml exec -T backend alembic upgrade head                                   
               sleep 10                                                                                                         
               curl -f http://localhost:8000/api/health || exit 1                                                               
               docker image prune -af                                                                                           
             EOF                                                                                                                
                                                                                                                                
     smoke-tests:                                                                                                               
       name: ðŸ§ª Smoke Tests                                                                                                     
       runs-on: ubuntu-latest                                                                                                   
       needs: [deploy-staging]                                                                                                  
       steps:                                                                                                                   
         - uses: actions/checkout@v4                                                                                            
         - uses: actions/setup-python@v5                                                                                        
           with:                                                                                                                
             python-version: '3.11'                                                                                             
         - run: pip install requests pytest                                                                                     
         - run: python tests/smoke_tests.py || true                                                                             
           env:                                                                                                                 
             STAGING_URL: https://staging.ats-platform.com                                                                      
           continue-on-error: true                                                                                              
                                                                                                                                
     deploy-production:                                                                                                         
       name: ðŸš€ Deploy to Production                                                                                            
       runs-on: ubuntu-latest                                                                                                   
       needs: [smoke-tests, deploy-staging]                                                                                     
       environment:                                                                                                             
         name: production                                                                                                       
         url: https://ats-platform.com                                                                                          
       if: github.ref == 'refs/heads/main' && github.event.inputs.environment == 'production'                                   
       steps:                                                                                                                   
         - uses: actions/checkout@v4                                                                                            
                                                                                                                                
         - name: Deploy to Production                                                                                           
           env:                                                                                                                 
             SSH_PRIVATE_KEY: ${{ secrets.PRODUCTION_SSH_KEY }}                                                                 
             SSH_HOST: ${{ secrets.PRODUCTION_HOST }}                                                                           
             SSH_USER: ${{ secrets.PRODUCTION_USER }}                                                                           
           run: |                                                                                                               
             mkdir -p ~/.ssh                                                                                                    
             echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa                                                                            
             chmod 600 ~/.ssh/id_rsa                                                                                            
             ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts                                                                     
                                                                                                                                
             ssh $SSH_USER@$SSH_HOST << 'EOF'                                                                                   
               cd /opt/ats-platform                                                                                             
               ./scripts/backup.sh                                                                                              
               docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/backend:latest                                           
               docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/frontend:latest                                          
               docker-compose -f docker-compose.prod.yml up -d --no-deps --scale backend=2 backend                              
               sleep 30                                                                                                         
               docker-compose -f docker-compose.prod.yml up -d --no-deps --scale backend=1 backend                              
               docker-compose -f docker-compose.prod.yml exec -T backend alembic upgrade head                                   
               curl -f http://localhost:8000/api/health || exit 1                                                               
               docker image prune -af                                                                                           
             EOF                                                                                                                
                                                                                                                                
         - name: Create GitHub Release                                                                                          
           uses: actions/create-release@v1                                                                                      
           env:                                                                                                                 
             GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}                                                                          
           with:                                                                                                                
             tag_name: v${{ github.run_number }}                                                                                
             release_name: Release v${{ github.run_number }}                                                                    
             body: |                                                                                                            
               ## Changes in this Release                                                                                       
               - Deployed from commit ${{ github.sha }}                                                                         
               - Pipeline: ${{ github.run_id }}                                                                                 
                                                                                                                                
     rollback:                                                                                                                  
       name: â†©ï¸ Rollback                                                                                                        
       runs-on: ubuntu-latest                                                                                                   
       needs: [deploy-production]                                                                                               
       if: failure() && github.ref == 'refs/heads/main'                                                                         
       steps:                                                                                                                   
         - uses: actions/checkout@v4                                                                                            
                                                                                                                                
         - name: Rollback Production                                                                                            
           env:                                                                                                                 
             SSH_PRIVATE_KEY: ${{ secrets.PRODUCTION_SSH_KEY }}                                                                 
             SSH_HOST: ${{ secrets.PRODUCTION_HOST }}                                                                           
             SSH_USER: ${{ secrets.PRODUCTION_USER }}                                                                           
           run: |                                                                                                               
             mkdir -p ~/.ssh                                                                                                    
             echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa                                                                            
             chmod 600 ~/.ssh/id_rsa                                                                                            
             ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts                                                                     
                                                                                                                                
             ssh $SSH_USER@$SSH_HOST << 'EOF'                                                                                   
               cd /opt/ats-platform                                                                                             
               ./scripts/rollback.sh                                                                                            
             EOF                                                                                                                
 ```
